%clc;clear;close
% m =20;n =10;p =4;
% A =randn(m,n);b =randn(m,1);
% C =randn(p,n);d =randn(p,1);e =rand;
% cvx_begin
%     variable x(n)
%     minimize(norm(A *x -b,2) )
%     subject to
%         C*x==d;
%         norm(x,Inf )<=e;
% cvx_end

%function []=cvx_test()
clear all;
close all;
clc
nn=1;
W=20;
%r=0.2725;
aird=1.168;
A=0.214;
% b=2;
% c=0.03175;
s=0.045;
%kk=0.17; 
k=0.11;
%del=0.012;
del=0.011;
%C_t=5.013e-5/(aird*A*(r^2));
%C_t=7.173e-5/(aird*A*(r^2));
C_t=1.195e-3;
SFP=0.009;
SFP2=0.377;
%SFP2=0.19;
%SFP_2=0.377;
v0=6.325;
n=4;
pb=W^(3/2)*C_t^(-3/2)*del*s/(8*sqrt(n*aird*A));
pin=(1+k)*W^(3/2)/sqrt(2*n*aird*A);
p1=3*del*s*sqrt(W*n*aird*A/C_t)/8;
p2=n*SFP*aird/2;
p3=2*v0^2;
p4=n*A*aird/4;
p5=p4^2;
p6=2*W/(n*aird*A);
p7=SFP2^2/A^2;
p8=n*SFP2*aird;
p9=n*aird*SFP2/4;
%% mintime 
% for i=1:50,
% v1(i)=0.1*i;
% end
% for i=1:300,
% v2(i)=0.1*i;
% end
% 
% r1=[1/10,2/10,3/10,4/10,5/10,6/10,7/10,8/10,9/10,1,10/9,10/8,10/7,10/6,10/5,10/4,10/3,10/2,10/1];
% minen=[99541.6,52684.4,43233,40939.7,41234.9,41234.2,41387.6,41199.3,41721.5,41854.4,41976.3,42095.7,42209.4,40506,40506,40506,40788.3,40788.3,42985.7];
% for j=1:length(r1),
%     vhoo=[];
%     rvh=[];
%     vhoo2=[];
%     vhoob=[];
%     vhoocd=[];
%     vhooc=[];
%     vhoob2=[];
%     vhoocd2=[];
%     vhooc2=[];
% for i=1:length(v1),
%     if v1(i)*(1/r1(j))>30,
%         break
%     end
% %vhoo(i)=((pin+pb+(p1*(v1(i)*(1/r1(j)))^2)+(pin*(sqrt(sqrt(1+((v1(i)*(1/r1(j)))^4/(4*v0^4)))-((v1(i)*(1/r1(j2)))^2/(2*v0^2)))-1))+(W*v1(i)/2)+(n*SFP2*aird*v1(i)^3/4)+(((W/2)+(n*SFP2*aird*v1(i)^2/4))*sqrt((2*W/(n*aird*A))+((1+(SFP2/A))*v1(i)^2))))*500/v1(i))+(p2*(500/v1(i))^(3/2)*(v1(i)*(1/r1(j)))^3);
% %vhoo(i)=((pb+(p1*(v1(i)/r1(j))^2)+(pin*sqrt(sqrt(1+((v1(i)/r1(j))^4/(4*(v0^4))))-((v1(i)/r1(j))^2/(2*(v0^2)))))+(W*v1(i)/2)+(p9*(v1(i)^3))+(((W/2)+p9*(v1(i)^2))*sqrt((p6)+((1+(SFP2/A))*(v1(i)^2)))))*(500/v1(i)))+(p2*((v1(i)/r1(j))^3)*((500/v1(i))^1.5));
% vhoo(i)=((pb+(p1*(v1(i)/r1(j))^2)+(pin*sqrt(sqrt(1+((v1(i)/r1(j))^4/(4*(v0^4))))-((v1(i)/r1(j))^2/(2*(v0^2)))))+(W*v1(i)/2)+(p9*(v1(i)^3))+(((W/2)+p9*(v1(i)^2))*sqrt((p6)+((1+(SFP2/A))*(v1(i)^2)))))+p2*((v1(i)/r1(j))^2))/sqrt(v1(i)^2+(v1(i)/r1(j))^2);
% vhoo2(i)=vhoo(i)*500*sqrt(((1/r1(j))^2)+1);
% vhoob(i)=(p9*(v1(i)^3))/sqrt(v1(i)^2+(v1(i)/r1(j))^2);
% vhoocd(i)=(((W/2)+p9*(v1(i)^2))*sqrt((p6)+((1+(SFP2/A))*(v1(i)^2))))/sqrt(v1(i)^2+(v1(i)/r1(j))^2);
% vhooc(i)=sqrt((p6)+((1+(SFP2/A))*(v1(i)^2)))/sqrt(v1(i)^2+(v1(i)/r1(j))^2);
% vhoob2(i)=vhoob(i)*500*sqrt(((1/r1(j))^2)+1);
% vhoocd2(i)=vhoocd(i)*500*sqrt(((1/r1(j))^2)+1);
% vhooc2(i)=vhooc(i)*500*sqrt(((1/r1(j))^2)+1);
% rvh(i)=((vhoo2(i)-minen(j))/vhoo2(i))*100;
% end
% vrr1{j}=vhoo2;
% vrr{j}=rvh;
% vrr2{j}=vhoob2;
% vrr3{j}=vhoocd2;
% vrr4{j}=vhooc2;
% %vrr1{j}=vhoo2;
% end
% %% 1 
% figure;
% yyaxis left 
% plot(v1(1:50),vrr1{19});
% hold on 
% line([0 5],[48212.9 48212.9],'linestyle','--','Linewidth',0.5);
% ylim([30000,200000]);
% yyaxis right 
% plot(v1(1:50),500./v1(1:50));
% ylim([0,10000]);
% hold on
% line([0 5],[114.8109 114.8109],'linestyle','--','Linewidth',0.5);
% figure; 
% %group_t=[repmat(0.5,size(vrr{1}',1),1);repmat(0.5,size(vrr{2}',1),1);]
% group_t=[zeros(1,length(vrr{1})),ones(1,length(vrr{2})),2*ones(1,length(vrr{3})),3*ones(1,length(vrr{4})),4*ones(1,length(vrr{5})),5*ones(1,length(vrr{6})),6*ones(1,length(vrr{7})),7*ones(1,length(vrr{8})),8*ones(1,length(vrr{9})),9*ones(1,length(vrr{10})),10*ones(1,length(vrr{11})),11*ones(1,length(vrr{12})),12*ones(1,length(vrr{13})),13*ones(1,length(vrr{14})),14*ones(1,length(vrr{15})),15*ones(1,length(vrr{16})),16*ones(1,length(vrr{17})),17*ones(1,length(vrr{18})),18*ones(1,length(vrr{19}))];
% allext_2=[vrr{1} vrr{2} vrr{3} vrr{4} vrr{5} vrr{6} vrr{7} vrr{8} vrr{9} vrr{10} vrr{11} vrr{12} vrr{13} vrr{14} vrr{15} vrr{16} vrr{17} vrr{18} vrr{19}];
% boxplot(allext_2,group_t);
% dtt1=[5025,2550.3,1739.8,1346.3,1118,971.3681,871.3352,800.3906,730,707.1072,672.6815,640.3127,610.3536,1083.1,1083.1,1083.1,1065.3,1065.3,991.0049];
% dtt2=[5000,2500,1666,1225,1000,833.3,714.28,625,555.55,500,450,400,350,300,250,200,150,100,50];
% for i=1:length(dtt1),
% ddt(i)=((dtt1(i)-dtt2(i))/dtt1(i))*100;
% end
% figure;
% x_1=1:1:19;
% plot(x_1,ddt,'-*b');
%% 通用模型的仿真分析
% %% 前上&前下
% for i=1:25,
% vup(i)=i*0.2;
% end
% for i=1:15,
% vdo(i)=i*0.2;
% end
% for i=1:120,
% vhor(i)=i*0.25;
% end
% for i=1:length(vup),
% pup(i)=(pin+pb+(W*vup(i)/2)+(n*SFP2*aird*vup(i)^3/4)+(((W/2)+(n*SFP2*aird*vup(i)^2/4))*sqrt((2*W/(n*aird*A))+((1+(SFP2/A))*vup(i)^2))))/vup(i);
% end
% for i=1:length(vdo),
% pdo(i)=(pin+pb+(W*vdo(i)/2)-(n*SFP2*aird*vdo(i)^3/4)+(((W/2)-(n*SFP2*aird*vdo(i)^2/4))*sqrt((2*W/(n*aird*A))+((1-(SFP2/A))*vdo(i)^2))))/vdo(i);
% end
% for i=1:length(vhor),
% phor(i)=(pb+(p1*vhor(i)^2)+(pin*sqrt(sqrt(1+(vhor(i)^4/(4*v0^4)))-(vhor(i)^2/(2*v0^2))))+(p2*vhor(i)^3))/vhor(i);
% end
% a1=min(pup);
% a2=min(pdo);
% a3=min(phor);
% kratio=[1/10,2/10,3/10,4/10,5/10,6/10,7/10,8/10,9/10,1,10/9,10/8,10/7,10/6,10/5,10/4,10/3,10/2,10/1];% vup/vhor
% for i=1:length(kratio),
% if i<=10
%     vhu=[];vhd=[];
% for j=1:length(vhor),
% if vhor(j)*kratio(i)>5
%    break;
% end
% vhu(j)=(pin+pb+(p1*vhor(j)^2)+(pin*(sqrt(sqrt(1+(vhor(j)^4/(4*v0^4)))-(vhor(j)^2/(2*v0^2)))-1))+(p2*vhor(j)^3)+(W*vhor(j)*kratio(i)/2)+(n*SFP2*aird*(vhor(j)*kratio(i))^3/4)+(((W/2)+(n*SFP2*aird*(vhor(j)*kratio(i))^2/4))*sqrt((2*W/(n*aird*A))+((1+(SFP2/A))*(vhor(j)*kratio(i))^2))))/sqrt((vhor(j)*kratio(i))^2+vhor(j)^2);
% vhd(j)=(pin+pb+(p1*vhor(j)^2)+(pin*(sqrt(sqrt(1+(vhor(j)^4/(4*v0^4)))-(vhor(j)^2/(2*v0^2)))-1))+(p2*vhor(j)^3)+(W*vhor(j)*kratio(i)/2)-(n*SFP2*aird*(vhor(j)*kratio(i))^3/4)+(((W/2)-(n*SFP2*aird*(vhor(j)*kratio(i))^2/4))*sqrt((2*W/(n*aird*A))+((1-(SFP2/A))*(vhor(j)*kratio(i))^2))))/sqrt((vhor(j)*kratio(i))^2+vhor(j)^2);
% end
% res{i}=vhu;
% res1{i}=vhd;
% else 
%     vhu2=[];vhd2=[];
% for k=1:length(vup),
%   if (vup(k)/kratio(i))>30
%    break;
%   end
% vhu2(k)=(pin+pb+(p1*(vup(k)/kratio(i))^2)+(pin*(sqrt(sqrt(1+((vup(k)/kratio(i))^4/(4*v0^4)))-((vup(k)/kratio(i))^2/(2*v0^2)))-1))+(p2*(vup(k)/kratio(i))^3)+(W*vup(k)/2)+(n*SFP2*aird*(vup(k))^3/4)+(((W/2)+(n*SFP2*aird*(vup(k))^2/4))*sqrt((2*W/(n*aird*A))+((1+(SFP2/A))*(vup(k))^2))))/sqrt((vup(k)/kratio(i))^2+vup(k)^2);
% vhd2(k)=(pin+pb+(p1*(vup(k)/kratio(i))^2)+(pin*(sqrt(sqrt(1+((vup(k)/kratio(i))^4/(4*v0^4)))-((vup(k)/kratio(i))^2/(2*v0^2)))-1))+(p2*(vup(k)/kratio(i))^3)+(W*vup(k)/2)-(n*SFP2*aird*(vup(k))^3/4)+(((W/2)-(n*SFP2*aird*(vup(k))^2/4))*sqrt((2*W/(n*aird*A))+((1-(SFP2/A))*(vup(k))^2))))/sqrt((vup(k)/kratio(i))^2+vup(k)^2);
% end
% res{i}=vhu2;
% res1{i}=vhd2;
% end
% end
% for i=1:19,
% minres(i)=min(res{i});
% minres1(i)=min(res1{i});
% end
%% ++++
% aa=[425,175,175];
% bb=[50,30,200];
% for i=1:3,
% resuu(i)=abs(aa(i)-bb(i));
% end
% kratio=[resuu(3)/sqrt(resuu(2)^2+resuu(1)^2)];
% for i=1:120,
% vhor(i)=i*0.25;
% end
% for i=1:length(kratio),
% for j=1:length(vhor),
% vhu(j)=(pin+pb+(p1*vhor(j)^2)+(pin*(sqrt(sqrt(1+(vhor(j)^4/(4*v0^4)))-(vhor(j)^2/(2*v0^2)))-1))+(p2*vhor(j)^3)+(W*vhor(j)*kratio(i)/2)+(n*SFP2*aird*(vhor(j)*kratio(i))^3/4)+(((W/2)+(n*SFP2*aird*(vhor(j)*kratio(i))^2/4))*sqrt((2*W/(n*aird*A))+((1+(SFP2/A))*(vhor(j)*kratio(i))^2))))/sqrt((vhor(j)*kratio(i))^2+vhor(j)^2);
% vhd(j)=(pin+pb+(p1*vhor(j)^2)+(pin*(sqrt(sqrt(1+(vhor(j)^4/(4*v0^4)))-(vhor(j)^2/(2*v0^2)))-1))+(p2*vhor(j)^3)+(W*vhor(j)*kratio(i)/2)-(n*SFP2*aird*(vhor(j)*kratio(i))^3/4)+(((W/2)-(n*SFP2*aird*(vhor(j)*kratio(i))^2/4))*sqrt((2*W/(n*aird*A))+((1-(SFP2/A))*(vhor(j)*kratio(i))^2))))/sqrt((vhor(j)*kratio(i))^2+vhor(j)^2);
% rvhu(j)=vhu(j)/(sqrt(vhor(j)^2+(vhor(j)*kratio(i))^2));
% rvhd(j)=vhd(j)/(sqrt(vhor(j)^2+(vhor(j)*kratio(i))^2));
% end 
% end
% minimume_1=min(vhu)*sqrt(resuu(1)^2+resuu(2)^2+resuu(3)^2);
% minimume_2=min(vhd)*sqrt(resuu(1)^2+resuu(2)^2+resuu(3)^2);
% minimumt_1=resuu(3)/(vhor(find(vhu==min(vhu)))*kratio(1));
% minimumt_2=resuu(3)/(vhor(find(vhd==min(vhd)))*kratio(1));
%% 前飞-最优速度
temp=zeros(1,2);
% yml=sqrt(sqrt((1/(4*v0^4))+(1/0.0001))-(1/(2*v0^2)))
% while nn<=20,
% cvx_begin gp
%       variable vm
%       variable ym
%       variable zm
%       %variable Tm
%       %variable ym
%       minimize((pb/vm)+(p1*vm)+(pin*ym)+(p2*vm^2)+abs(zm));
%       subject to
%       %zm=quad_over_lin(pow_p(vm,-4),pow_pos(ym,2));
%       %temp(1,:)=pow_pos(vm,2);
%       %zm=quad_over_lin(temp(:,2),pow_pos(ym,2));
%       %zm=rel_entr(pow_p(vm,-4),pow_p(ym,-2));
%       %zm=prod_inv([vm^4 ym^2]);
%       %yml=sqrt(sqrt((1/(4*v0^4))+(1/))-(1/(2*v0^2)))
%       %tm=-2*yml*ym;
%       %pow_p(vm,-4)*pow_p(ym,-2)+yml^2-(1/v0^2)-2*yml*ym<=0;
%       %pow_p(vm,-4)*pow_p(ym,-3)-2*yml<=((1/v0^2)-yml^2)*pow_p(ym,-1);
%       ym>=0;
%       vm>=0.001;
%       vm<=30;
%       %((1/v0^2)-yml^2)*pow_p(ym,-1)+2*yml>=pow_p(vm,-4)*pow_p(ym,-3);
%       %pow_p(vm,-4)*pow_p(ym,-2)<=pow_p(v0,-2)-yml^2;
%       %zm<=2*yml*ym;
%       zm+yml*2*ym<=0;
%       pow_p(vm,-4)*pow_p(ym,-2)+pow_pos(yml,2)-pow_p(v0,-2)+zm<=0;
% cvx_end
% yml=ym;
% nn=nn+1;
% end
% for i=1:290,
% vp(i)=1+0.1*i;
% yp(i)=(pb/vp(i))+(p1*vp(i))+(p2*vp(i)^2)+(pin*sqrt(sqrt((1/(4*v0^4))+(1/vp(i)^4))-(1/(2*v0^2))));
% end
% figure;
% plot(vp,yp,'-b');
% fprintf('%d',vp(find(yp==min(yp))));
%% 前飞-最优轨迹
% for i=1:300,
% vhor(i)=i*0.1;
% end
% for i=1:length(vhor),
% phor(i)=(pb+(p1*vhor(i)^2)+(pin*sqrt(sqrt(1+(vhor(i)^4/(4*v0^4)))-(vhor(i)^2/(2*v0^2))))+(p2*vhor(i)^3))/vhor(i);
% end
% min11=min(phor);
% fmin11=find(phor==min(phor));
%%  
% N=70;
% qml=zeros(N+1,2);
% yml=zeros(N,1);
% Tml=zeros(N,1);
% %qml(1,1)= 0;
% %qml(1,2) 0;
% for n=1:N,
% qml(n,1)=-1+(n*0.5);
% qml(n,2)=-1+(n*0.1);
% %yml(n)=sqrt(sqrt(1+(norms(qml(n+1,:)-qml(n,:),2)^4/p3^2))-(norms(qml(n+1,:)-qml(n,:),2)^2/p3));
% end
% qml(N+1,1)=80;
% qml(N+1,2)=60;
% for n=1:N,
% yml(n)=sqrt(sqrt(1+(norms(qml(n+1,:)-qml(n,:),2)^4/p3^2))-(norms(qml(n+1,:)-qml(n,:),2)^2/p3));
% end
% M=0;
% delm=zeros(N,2);
% resu=0;
% while M<=100,
% %     if M>=1 & resu-temp<=0.01
% %     break;
% %     end
% cvx_begin 
% variable q(N+1,2);
% variables Tm(N) ym(N) 
% expressions Sum_ener(1,N) delm(N,2) del(N) dell(N,2);
% 
% for n=1:N,
% delm(n,:)=(sqrt(2)/2)*(q(n+1,:)-q(n,:));
% %delm(2,n)=0;
% %pow_pos(delm(n),2)*pow_p(Tm(n),-1)
% %del(n)=pow_pos(quad_over_lin(q(n+1,:)-q(n,:),Tm(n)),1.5);
% %del(n)=quad_over_lin(q(n,:),Tm(n));
% %dell(n)=quad_over_lin(q(n,:),Tm(n));
% %del(n)=quad_over_lin(q(n+1,:)-q(n,:),2,Tm(n));
% %dell(n)=(p2*pow_pos(quad_over_lin(delm(n,:),pow_p(Tm(n),2/3)),3))
% %dell(n,1)=pow_pos(Tm(n),4);
% 
% dell(n,:)=(sqrt(2)/2)*Tm(n);
% Sum_ener(1,n)=(pb*Tm(n))+(p1*quad_over_lin(delm(n,:),Tm(n)))+(pin*ym(n))+(p2*pow_pos(quad_over_lin(delm(n,:),pow_p(Tm(n),2/3)),3));
% %Sum_ener(1,n)=pb*Tm(n);
% end
% minimize (sum(Sum_ener))
% subject to
% % q(1,:) == [0,0];
% % %q(N+1,1) == 800;
% % %q(N+1,2) == 800;
% % q(N+1,:) == [800,800];
% % for n=1:N
% % norm(q(n+1,:)-q(n,:),2)<=10;
% % %pow_pos(Tm(n),4)*pow_p(ym(n),-2)<=pow_pos(yml(n),2)+(2*yml(n)*(ym(n)-yml(n)))-(2*norm(qml(n+1,:)-qml(n,:),2)^2/p3)+4*(qml(n+1,:)-qml(n,:))*(q(n+1,:)-q(n,:))';
% % %pow_pos(quad_over_lin(dell(n,:),pow_p(ym(n),0.5)),2)<=pow_pos(yml(n),2)+2*yml(n)*ym(n)-2*yml(n)^2;
% % Tm(n)>=0.33;
% % Tm(n)<=4;
% % ym(n)>=0;
% % end
% q(1,1)==0;q(1,2)==0;
% q(N+1,1)==80;q(N+1,2)==60;
% q(N/2,1)==20;q(N/2,2)==25;
% q(N*6/7,1)==70;q(N*6/7,2)==40;
% for n=1:N,
% norm(q(n+1,:)-q(n,:),2)<=10;
% end
% for n=1:N,
% %Tm(n)>=0.33;
% quad_over_lin(q(n+1,:)-q(n,:),Tm(n))<=900*Tm(n);
% %norms(q(n+1,:)-q(n,:),2)/Tm(n)<=30;
% end
% for n=1:N,
% Tm(n)>=0;
% end
% for n=1:N,
% ym(n)>=0;
% end
% % for n=1:N,
% % -35<=-q(n,2)<=-25;
% % end
% for n=1:N,
% pow_pos(quad_over_lin(dell(n,:),ym(n)),2)<=pow_pos(yml(n),2)+2*yml(n)*ym(n)-2*yml(n)^2-(2*norm(qml(n+1,:)-qml(n,:),2)^2/p3)+(4*(qml(n+1,:)-qml(n,:))*(q(n+1,:)-q(n,:))'/p3);
% end
% cvx_end
% M=M+1;
% for n=1:N,
% yml(n)=ym(n);
% end
% for n=1:N+1,
% qml(n,:)=q(n,:);
% end
% for n=1:N,
% Tml(n)=Tm(n);
% end
% temp=resu;
% resu=Sum_ener;
% end
% figure;
% plot(qml(:,1),qml(:,2),'-*b')
% %resu=Sum_ener;
% 
% xx=norm(qml(2,:)-qml(1,:),2);
%% 前上升最优轨迹
M=0;
N=200;
qml=zeros(N+1,3);
yml=zeros(N,1);
Tml=zeros(N,1);
Bml=zeros(N,1);
Cml=zeros(N,1);
Dml=zeros(N,1);
Eml=zeros(N,1);
% target1=[0,0,0];
% target2=[1333,1000,500];
for n=1:N+1,
%qml(n,:)=[target1(1)+((target2(1)-target1(1))*(n-1)/N),target1(2)+((target2(2)-target1(2))*(n-1)/N),target1(3)+((target2(3)-target1(3))*(n-1)/N)];
qml(n,:)=[n-1,n-1,n-1]
end
for n=1:N,
yml(n)=sqrt(sqrt(1+(norms(qml(n+1,1:2)-qml(n,1:2),2)^4/p3^2))-(norms(qml(n+1,1:2)-qml(n,1:2),2)^2/p3));
end
for n=1:N,
Tml(n)=1;
end
for n=1:N,
Bml(n)=p9*((qml(n+1,3)-qml(n,3))^3)/(Tml(n)^2);
end
for n=1:N,
Cml(n)=sqrt((qml(n+1,3)-qml(n,3))^2+(p6*Tml(n)^2)+(SFP2*abs(qml(n+1,3)-qml(n,3))*(qml(n+1,3)-qml(n,3))/A));
end
for n=1:N,
%Dml(n)=-p4*Cml(n)*(abs(qml(n+1,3)-qml(n,3))^2+(p6*Tml(n)^2));
Dml(n)=Cml(n)^3/Tml(n)^2;
end
for n=1:N,
Eml(n)=-p4*Cml(n)*((qml(n+1,3)-qml(n,3))/Tml(n))^2;
end
% for n=1:N,
% Eml(n)=SFP2*(qml(n+1,3)-qml(n,3))/A;
% end
while M<=100,
cvx_begin
variables q(N+1,3) Tm(N) ym(N) Bbm(N) Cm(N)  Dm(N) Em(N) 
expressions Sum_ener(1,N) delq(N,2) delz(N,2) delc(N,2) dell(N,2) delq2(N,2) delq1(N,2) fh(N,2) gh(N,2) DDm(N)
%% 为了处理quad_over_lin问题
% for n=1:N,
% te(n)=norms(q(n+1,1:2)-q(n,1:2),2);
% %tel(n)=q(n+1,1)-q(n,1);
% delq1(n,:)=sqrt(1/2)*(q(n+1,1)-q(n,1));
% delq2(n,:)=-sqrt(1/2)*pow_p(q(n+1,2)-q(n,2),1/2);
% %delq(n,1)=quad_over_lin(delq1(n,:),te(n));
% %delq(n,:)=(q(n+1,1:2)-q(n,1:2))/pow_p(te(n),1/2);
% end
% for n=1:N,
% delq(n,1)=quad_over_lin(delq1(n,:),pow_p(te(n),1/2));
% delq(n,2)=quad_over_lin(delq2,pow_p(te(n),1/2));
% end
% for n=1:N,
% delz(n,:)=sqrt(1/2)*pow_p(abs(q(n+1,3)-q(n,3)),0.5);
% end
% for n=1:N,
% %gh(n)=pow_pos(quad_over_lin(q(n+1,3)-q(n,3),-pow_pos(Tm(n),4/3)),3/2);
% % 绝对值的问题
% gh(n,:)=quad_over_lin(q(n+1,3)-q(n,3),Tm(n));
% end
% for n=1:N,
% ghh(n,:)=quad_over_lin(q(n+1,3)-q(n,3),Tm(n));
% end
for n=1:N,
delz(n,:)=sqrt(1/2)*(q(n+1,3)-q(n,3));
%delz(n,:)=quad_over_lin(q(n+1,3)-q(n,3),Tm(n));
%delz(n,:)=sqrt(1/2)*sqrt(q(n+1,3)-q(n,3));
end
for n=1:N,
%delc(n,:)=sqrt(1/2)*pow_p(Cm(n),0.5);
delc(n,:)=sqrt(1/2)*Cm(n);
end
for n=1:N,
dell(n,:)=(sqrt(2)/2)*Tm(n);
end
for n=1:N,
DDm(n)=quad_over_lin(Cm(n),Tm(n));
end
% for n=1:N,
% Dm(n)=quad_over_lin(DDm(n),Cm(n));
% end
%% 只考虑运动状态，没有涉及悬停状态
for n=1:N,
%% 修改公式
%Sum_ener(n)=(pb*Tm(n))+(p1*quad_over_lin(q(n+1,1:2)-q(n,1:2),Tm(n)))+(pin*ym(n))+(p2*pow_pos(quad_over_lin(q(n+1,1:2)-q(n,1:2),Tm(n)),3))+(W*abs(q(n+1,3)-q(n,3))/2)+(pow_pos(quad_over_lin(delc(n,:),pow_p(Tm(n),2/3)),3)*p4)+Bbm(n)+(p4*Dm(n));
%Sum_ener(n)=(pb*Tm(n))+(p1*quad_over_lin(q(n+1,1:2)-q(n,1:2),Tm(n)))+(pin*ym(n))+(p2*quad_over_lin(q(n+1,1:2)-q(n,1:2),Tm(n)))+(W*abs(q(n+1,3)-q(n,3))/2)+Bbm(n)+(p4*pow_pos(Cm(n),3))+(W*Cm(n)/2)+Dm(n);
Sum_ener(n)=(pb*Tm(n))+(p1*quad_over_lin(q(n+1,1:2)-q(n,1:2),Tm(n)))+(pin*ym(n))+(p2*quad_over_lin(q(n+1,1:2)-q(n,1:2),Tm(n)))+(W*abs(q(n+1,3)-q(n,3))/2)+Bbm(n)+(p4*Dm(n))+Em(n);
%Sum_ener(n)=(pin*ym(n));
end
minimize(sum(Sum_ener))
subject to
q(1,:) == [425,175,175];
q(N+1,:) == [350,275,250];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
for n=1:N,
Tm(n)>=0;
end
%% 限制离散移动距离
for n=1:N,
norm(q(n+1,1:2)-q(n,1:2),2)<=100;
end
for n=1:N,
norm(q(n+1,3)-q(n,3),2)<=50;
end
% for n=1:N,
% 
% end
% for n=1:N,
% 
% end
%% 限制水平和垂直飞行速度
for n=1:N,
quad_over_lin(q(n+1,1:2)-q(n,1:2),Tm(n))<=900*Tm(n);
%quad_over_lin(delz(n,:),Tm(n))<=25*Tm(n);
%quad_over_lin(q(n+1,3)-q(n,3),2)
abs(q(n+1,3)-q(n,3))<=5*Tm(n);
end
% for n=1:N,
% abs(q(n+1,3)-q(n,3))>=0.000001;
% end
%% ym约束条件
for n=1:N,
ym(n)>=0;
end
for n=1:N,
pow_pos(quad_over_lin(dell(n,:),ym(n)),2)<=pow_pos(yml(n),2)+2*yml(n)*ym(n)-2*yml(n)^2-(2*norm(qml(n+1,1:2)-qml(n,1:2),2)^2/p3)+(4*(qml(n+1,1:2)-qml(n,1:2))*(q(n+1,1:2)-q(n,1:2))'/p3);
end
%% Bm约束条件
% for n=1:N,
% Bbm(n)>=0;
% end
% for n=1;N,
% %p5* pow_pos(quad_over_lin(delz(n,:),Tm(n)),3)<=(pow_pos(Bml(n),2)*Tml(n))+(2*Bml(n)*Tml(n)*(Bbm(n)-Bml(n)))+2*Bml(n)*(Tm(n)-Tml(n));
% p4*pow_pos(q(n+1,3)-q(n,3),3)<=(pow_pos(Tml(n),2)*Bml(n))+(2*Tml(n)*Bml(n)*(Tm(n)-Tml(n)))+pow_pos(Tml(n),2)*(Bbm(n)-Bml(n));
% end
%% 保证Bm和qm相同符号
for n=1:N,
%(Bml(n)*(qml(n,3)-qml(n+1,3)))+((qml(n,3)-qml(n+1,3))*(q(n,3)-q(n+1,3)-(qml(n,3)-qml(n+1,3))))+(Bml(n)*(Bbm(n)-Bml(n)))<=0;
%(Bml(n)*(qml(n,3)-qml(n+1,3)))+((qml(n,3)-qml(n+1,3))*(Bbm(n)-Bml(n)))+(Bml(n)*(q(n,3)-q(n+1,3)-(qml(n,3)-qml(n+1,3))))<=0;
pow_abs(Bbm(n)+q(n,3)-q(n+1,3),2)-(2*(Bml(n)+qml(n+1,3)-qml(n,3))*(Bbm(n)-Bml(n)+(q(n,3)-q(n+1,3))-(qml(n,3)-qml(n+1,3))))-pow_abs(Bml(n)+qml(n+1,3)-qml(n,3),2)<=0;
end
for n=1:N,
%p9*pow_pos(q(n+1,3)-q(n,3),3)<=(Bml(n)*Tml(n)^2)+(Tml(n)^2*(Bbm(n)-Bml(n)))+(2*Tml(n)*Bml(n)*(Tm(n)-Tml(n)));
%% 上升
p9*(q(n+1,3)-q(n,3))<=(pow_pos(Tml(n),2)*Bml(n)/pow_abs(qml(n+1,3)-qml(n,3),2))+(2*Tml(n)*Bml(n)*(Tm(n)-Tml(n))/pow_abs(qml(n+1,3)-qml(n,3),2))+(pow_pos(Tml(n),2)*(Bbm(n)-Bml(n))/pow_abs(qml(n+1,3)-qml(n,3),2))+(-2*pow_pos(Tml(n),2)*Bml(n)*(q(n+1,3)-q(n,3)-qml(n+1,3)+qml(n,3))/pow_pos(qml(n+1,3)-qml(n,3),3));
%% 下降
%p9*(q(n+1,3)-q(n,3))<=(pow_pos(Tml(n),2)*Bml(n)/pow_abs(qml(n+1,3)-qml(n,3),2))+(2*Tml(n)*Bml(n)*(Tm(n)-Tml(n))/pow_abs(qml(n+1,3)-qml(n,3),2))+(pow_pos(Tml(n),2)*(Bbm(n)-Bml(n))/pow_abs(qml(n+1,3)-qml(n,3),2))+(-2*pow_pos(Tml(n),2)*Bml(n)*(q(n+1,3)-q(n,3)-qml(n+1,3)+qml(n,3))/(-pow_abs((qml(n+1,3)-qml(n,3)),3)));
%0>=-((Bml(n)*pow_pos(Tml(n),2))+(2*Tml(n)*Bml(n)*(Tm(n)-Tml(n)))+(pow_pos(Tml(n),2)*(Bbm(n)-Bml(n))))+(3*p9*pow_abs(qml(n+1,3)-qml(n,3),2)*(q(n+1,3)-q(n,3)-qml(n+1,3)+qml(n,3)));
end
%% Em约束条件`
% for n=1:N,
% Em(n)>=0;
% end
% for n=1:N,
% %p7*pow_pos(norms(delz(n,:),2),4)<=pow_pos(Eml(n),2)+(2*Eml(n)*(Em(n)-Eml(n)));
% p7*pow_pos(q(n+1,3)-q(n,3),4)<=pow_pos(Eml(n),2)+(2*Eml(n)*(Em(n)-Eml(n)));
% end
%% Cm约束条件
for n=1:N
Cm(n)>=0;
end
for n=1:N,
%p6*Tm(n)^2+pow_pos(norms(delz(n,:),2),2)+Em(n)<=pow_pos(Cml(n),2)+(2*Cml(n)*(Cm(n)-Cml(n)));
%(SFP2*pow_pos(q(n+1,3)-q(n,3),3)/A)+pow_pos(abs(q(n+1,3)-q(n,3)),3)<=pow_pos(Cml(n),2)*abs(qml(n+1,3)-qml(n,3))+(2*Cml(n)*abs(qml(n+1,3)-qml(n,3))*(Cm(n)-Cml(n)))+((qml(n+1,3)-(qml(n,3))/abs(qml(n+1,3)-qml(n,3)))*pow_pos(Cml(n),2)*(q(n+1,3)-q(n,3)-qml(n+1,3)+qml(n,3)))-(p6*(Tml(n)^2*abs(qml(n+1,3)-qml(n,3))+(2*Tml(n)*abs(qml(n+1,3)-qml(n,3))*(Tm(n)-Tml(n)))+((qml(n+1,3)-(qml(n,3))/abs(qml(n+1,3)-qml(n,3)))*pow_pos(Tml(n),2)*(q(n+1,3)-q(n,3)-qml(n+1,3)+qml(n,3)))));
%% 上升
pow_pos(q(n+1,3)-q(n,3),2)+(p6*pow_pos(Tm(n),2))+(SFP2*(pow_pos(abs(q(n+1,3)-q(n,3))+q(n+1,3)-q(n,3),2)-(2*(qml(n+1,3)-qml(n,3)-abs(qml(n+1,3)-qml(n,3)))*(q(n+1,3)-q(n,3)-abs(q(n+1,3)-q(n,3))-(qml(n+1,3)-qml(n,3)-abs(qml(n+1,3)-qml(n,3)))))-pow_pos(qml(n+1,3)-qml(n,3)-abs(qml(n+1,3)-qml(n,3)),2))/(4*A))<=pow_pos(Cml(n),2)+(2*Cml(n)*(Cm(n)-Cml(n)));
%% 下降
%pow_pos(q(n+1,3)-q(n,3),2)+(p6*pow_pos(Tm(n),2))+(SFP2*(-(2*(qml(n+1,3)-qml(n,3)-abs(qml(n+1,3)-qml(n,3)))*(-2*(q(n+1,3)-q(n,3))-(qml(n+1,3)-qml(n,3)-abs(qml(n+1,3)-qml(n,3)))))-pow_abs(qml(n+1,3)-qml(n,3)-abs(qml(n+1,3)-qml(n,3)),2))/(4*A))<=pow_pos(Cml(n),2)+(2*Cml(n)*(Cm(n)-Cml(n)));

%pow_pos(abs(q(n+1,3)-q(n,3)),2)+(p6*pow_pos(Tm(n),2))+(SFP2*((-2*(qml(n+1,3)-qml(n,3)-abs(qml(n+1,3)-qml(n,3)))*((2*(q(n+1,3)-q(n,3)))-(qml(n+1,3)-qml(n,3)-abs(qml(n+1,3)-qml(n,3)))))-pow_abs(qml(n+1,3)-qml(n,3)-abs(qml(n+1,3)-qml(n,3)),2))/(4*A))<=pow_pos(Cml(n),2)+(2*Cml(n)*(Cm(n)-Cml(n)));
end
%-(2*(qml(n+1,3)-qml(n,3)-abs(qml(n+1,3)-qml(n,3)))*(q(n+1,3)-q(n,3)-abs(q(n+1,3)-q(n,3)-qml(n+1,3)-qml(n,3)+abs(qml(n+1,3)-qml(n,3)))))
%% 三次/二次的约束
for n=1:N,
Dm(n)>=0
end
for n=1:N,
0>=pow_pos(Cm(n),3)-((Dml(n)*pow_pos(Tml(n),2))+(2*Dml(n)*Tml(n)*(Tm(n)-Tml(n)))+(pow_pos(Tml(n),2)*(Dm(n)-Dml(n))));
end
%% Em 约束条件
for n=1:N,
Em(n)<=0;
end
% for n=1:N,
% (-Dml(n)/Cml(n))-((Dm(n)-Dml(n))/Cml(n))+(Dml(n)*(Cm(n)-Cml(n))/Cml(n)^2)+abs(qml(n+1,3)-qml(n,3))^2/Tml(n)^2-(2*(qml(n+1,3)-qml(n,3))*(q(n+1,3)-q(n,3))/Tml(n)^2)+(2*abs(qml(n+1,3)-qml(n,3))^2*(Tm(n)-Tml(n))/Tml(n)^3)<=0
% end
for n=1:N,
%-Dm(n)/p4<=(Cml(n)*pow_pos(qml(n+1,3)-qml(n,3),2))+(pow_pos(qml(n+1,3)-qml(n,3),2)*(Cm(n)-Cml(n)))+(2*(abs(qml(n+1,3)-qml(n,3)))*Cml(n)*(q(n+1,3)-q(n,3)-qml(n+1,3)+qml(n,3)))+(Cml(n)*p6*Tml(n)^2)+(p6*Tml(n)^2*(Cm(n)-Cml(n)))+(2*p6*Tml(n)*Cml(n)*(Tm(n)-Tml(n)));
%-Dm(n)/p4<=(Cml(n)*pow_pos(qml(n+1,3)-qml(n,3),2)+(pow_pos(qml(n+1,3)-qml(n,3),2)*(Cm(n)-Cml(n)))+(2*(qml(n+1,3)-qml(n,3))*Cml(n)*(q(n+1,3)-q(n,3)-qml(n+1,3)+qml(n,3)))+(p6*Cml(n)*pow_pos(Tml(n),2))+(p6*pow_pos(Tml(n),2)*(Cm(n)-Cml(n)))+(p6*2*Tml(n)*Cml(n)*(Tm(n)-Tml(n))));
%Dm(n)>=-p4*(Cml(n)*pow_pos(abs(qml(n+1,3)-qml(n,3)),2)+(pow_pos(abs(qml(n+1,3)-qml(n,3)),2)*(Cm(n)-Cml(n)))+(2*(qml(n+1,3)-qml(n,3))*Cm(n)*(q(n+1,3)-q(n,3)-(qml(n+1,3)-qml(n,3)))))-((W/2)*(Cml(n)*pow_pos(Tm(n),2)+(pow_pos(Tm(n),2)*(Cm(n)-Cml(n)))+(2*Tml(n)*Cml(n)*(Tm(n)-Tml(n)))));
0>=-((pow_pos(Tml(n),2)*Eml(n))+(2*Tml(n)*Eml(n)*(Tm(n)-Tml(n)))+(pow_pos(Tml(n),2)*(Em(n)-Eml(n))))-(p4*((pow_abs(qml(n+1,3)-qml(n,3),2)*(Cm(n)-Cml(n)))+(2*(qml(n+1,3)-qml(n,3))*Cml(n)*(q(n+1,3)-q(n,3)-(qml(n+1,3)-qml(n,3))))+(Cml(n)*pow_abs(qml(n+1,3)-qml(n,3),2))));

end
%+(2*(qml(n+1,3)-qml(n,3))*Cml(n)*(q(n+1,3)-q(n,3)-qml(n+1,3)+qml(n,3)))
%+(2*(qml(n+1,3)-qml(n,3))*Cml(n)*(abs(q(n+1,3)-q(n,3))-abs(qml(n+1,3)-qml(n,3))))
%% 
cvx_end
M=M+1;
for n=1:N,
yml(n)=ym(n);
end
for n=1:N+1,
qml(n,:)=q(n,:);
end
for n=1:N,
Tml(n)=Tm(n);
end
for n=1:N,
Bml(n)=Bbm(n);
end
for n=1:N,
Cml(n)=Cm(n);
end
for n=1:N,
Dml(n)=Dm(n);
end
for n=1:N,
eneres(n)=Sum_ener(n);
end
for n=1:N,
Eml(n)=Em(n);
end
end
for i=1:N,
sum1(i)=(p4*pow_pos(Cml(i),3))+(W*Cml(i)/2)+Dml(i);
end 
hh=sum(sum1);
h1=sum(Bml);
h2=sum(Cml);
figure;
plot3([qml(1,1) qml(N+1,1)],[qml(1,2) qml(N+1,2)],[qml(1,3) qml(N+1,3)],'-p');
hold on 
plot3(qml(:,1),qml(:,2),qml(:,3),'m-p');
for i=1:N,
rrtt(i)=(abs(qml(i+1,3)-qml(i,3))/Tml(i))/(norms(qml(i+1,1:2)-qml(i,1:2),2)/Tml(i));
ryu(i)=eneres(i)/(Tml(i)*sqrt((abs(qml(i+1,3)-qml(i,3))/Tml(i))^2+(norms(qml(i+1,1:2)-qml(i,1:2),2)/Tml(i))^2));
end
for i=1:N,
xhh(i)=(p2*(quad_over_lin(qml(i+1,1:2)-qml(i,1:2),Tml(i)))^(3/2)/Tml(i)^(1/2))*(1-(1/Tml(i)^(1/2)));
end
sumxh=sum(xhh);
suuu=sum(Tml);
for i=1:N,
dest(i)=norms(qml(i+1,:)-qml(i,:),2);
end
sudest=sum(dest);

figure;
qml=smooth(qml);
plot3(qml(:,1),qml(:,2),qml(:,3),'m-');